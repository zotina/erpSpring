{"version":3,"file":"workflow-BVhqibwi.js","sources":["../../../../frontend/src/data/currencies.js","../../../../frontend/src/components/FilePreviewModal.vue","../../../../frontend/src/components/WorkflowActionSheet.vue","../../../../frontend/src/composables/workflow.js"],"sourcesContent":["import { createResource } from \"frappe-ui\"\n\nconst companyCurrency = createResource({\n\turl: \"hrms.api.get_company_currencies\",\n\tauto: true,\n})\n\nconst currencySymbols = createResource({\n\turl: \"hrms.api.get_currency_symbols\",\n\tauto: true,\n})\n\nexport function getCompanyCurrency(company) {\n\treturn companyCurrency?.data?.[company]?.[0]\n}\n\nexport function getCompanyCurrencySymbol(company) {\n\treturn companyCurrency?.data?.[company]?.[1]\n}\n\nexport function getCurrencySymbol(currency) {\n\treturn currencySymbols?.data?.[currency]\n}\n","<template>\n\t<ion-header>\n\t\t<ion-toolbar>\n\t\t\t<ion-title>{{ filename }} - {{ __(\"File Preview\") }}</ion-title>\n\t\t\t<ion-buttons slot=\"end\">\n\t\t\t\t<ion-button @click=\"modalController.dismiss()\">{{ __(\"Close\") }} </ion-button>\n\t\t\t</ion-buttons>\n\t\t</ion-toolbar>\n\t</ion-header>\n\t<ion-content>\n\t\t<div class=\"bg-white h-full w-full overflow-auto touch-pinch-zoom\">\n\t\t\t<img v-if=\"isImageFile\" :src=\"src\" class=\"h-auto image-preview\" />\n\t\t\t<iframe v-else :src=\"src\" class=\"w-full h-full\"></iframe>\n\t\t</div>\n\t</ion-content>\n</template>\n\n<script setup>\nimport { computed, onBeforeUnmount } from \"vue\"\nimport {\n\tIonHeader,\n\tIonToolbar,\n\tIonContent,\n\tIonButtons,\n\tIonTitle,\n\tIonButton,\n\tmodalController,\n} from \"@ionic/vue\"\n\nconst props = defineProps({\n\tfile: {\n\t\ttype: Object,\n\t\trequired: true,\n\t},\n})\n\nconst filename = computed(() => {\n\treturn props.file.file_name || props.file.name\n})\n\nconst src = computed(() => {\n\treturn props.file.file_url\n\t\t? props.file.file_url\n\t\t: URL.createObjectURL(props.file)\n})\n\nconst isImageFile = computed(() => {\n\treturn /\\.(gif|jpg|jpeg|tiff|png|svg)$/i.test(filename.value)\n})\n\nonBeforeUnmount(() => {\n\tURL.revokeObjectURL(src.value)\n})\n</script>\n\n<style scoped>\n.image-preview {\n\timage-orientation: from-image;\n}\n</style>\n","<template>\n\t<div\n\t\tv-if=\"actions.length > 0\"\n\t\t:class=\"[\n\t\t\tprops.view === 'form'\n\t\t\t\t? 'px-4 pt-4 pb-4 standalone:pb-safe-bottom sm:w-96 bg-white sticky bottom-0 w-full drop-shadow-xl z-40 border-t rounded-t-lg'\n\t\t\t\t: 'flex w-full flex-row items-center justify-between gap-3 sticky bottom-0 border-t z-[100] p-4',\n\t\t]\"\n\t>\n\t\t<Button\n\t\t\tv-if=\"props.view === 'form' || actions.length > 2\"\n\t\t\t@click=\"showTransitions()\"\n\t\t\tclass=\"w-full rounded py-5 text-base disabled:bg-gray-700 disabled:text-white\"\n\t\t\tvariant=\"solid\"\n\t\t>\n\t\t\t<template #prefix>\n\t\t\t\t<FeatherIcon name=\"chevron-up\" class=\"w-4\" />\n\t\t\t</template>\n\t\t\t{{ __(\"Actions\") }}\n\t\t</Button>\n\n\t\t<template v-else>\n\t\t\t<Button\n\t\t\t\tv-for=\"action in actions\"\n\t\t\t\tclass=\"w-full py-5\"\n\t\t\t\t:variant=\"action.variant\"\n\t\t\t\t:theme=\"action.theme\"\n\t\t\t\t@click=\"applyWorkflow({ workflowAction: action.text })\"\n\t\t\t>\n\t\t\t\t<template #prefix v-if=\"action.featherIcon\">\n\t\t\t\t\t<FeatherIcon :name=\"action.featherIcon\" class=\"w-4\" />\n\t\t\t\t</template>\n\t\t\t\t{{ __(action.text, null, props.doc?.doctype) }}\n\t\t\t</Button>\n\t\t</template>\n\t</div>\n\n\t<ion-action-sheet\n\t\t:buttons=\"actions\"\n\t\t:is-open=\"showActionSheet\"\n\t\t@didDismiss=\"applyWorkflow({ event: $event })\"\n\t>\n\t</ion-action-sheet>\n</template>\n\n<script setup>\nimport { IonActionSheet, modalController } from \"@ionic/vue\"\nimport { computed, ref, onMounted, inject } from \"vue\"\nimport { FeatherIcon } from \"frappe-ui\"\n\nconst props = defineProps({\n\tdoc: {\n\t\ttype: Object,\n\t\trequired: true,\n\t},\n\tworkflow: {\n\t\ttype: Object,\n\t\trequired: false,\n\t},\n\tview: {\n\t\ttype: String,\n\t\tdefault: \"form\",\n\t\tvalidator: (value) => [\"form\", \"actionSheet\"].includes(value),\n\t},\n})\n\nconst emit = defineEmits([\"workflow-applied\"])\n\nlet showActionSheet = ref(false)\nlet actions = ref([])\n\nconst __ = inject(\"$translate\")\n\nconst getTransitions = async () => {\n\tconst transitions = await props.workflow.getTransitions(props.doc)\n\tactions.value = transitions.map((transition) => {\n\t\tlet role = \"\"\n\t\tlet theme = \"gray\"\n\t\tlet variant = \"subtle\"\n\t\tlet icon = \"\"\n\t\tlet actionLabel = transition.toLowerCase()\n\n\t\tif (actionLabel.includes(\"reject\") || actionLabel.includes(\"cancel\")) {\n\t\t\trole = \"destructive\"\n\t\t\ttheme = \"red\"\n\t\t\tvariant = \"subtle\"\n\t\t\ticon = \"x\"\n\t\t} else if (actionLabel.includes(\"approve\")) {\n\t\t\ttheme = \"green\"\n\t\t\tvariant = \"solid\"\n\t\t\ticon = \"check\"\n\t\t}\n\n\t\treturn {\n\t\t\ttext: __(transition, null, props.doc?.doctype),\n\t\t\trole: role,\n\t\t\ttheme: theme,\n\t\t\tvariant: variant,\n\t\t\tfeatherIcon: icon,\n\t\t\tdata: {\n\t\t\t\taction: transition,\n\t\t\t},\n\t\t}\n\t})\n}\n\nconst showTransitions = () => {\n\tif (actions.value?.length > 0) {\n\t\t// always add last action for dismissing the modal\n\t\tactions.value.push({\n\t\t\ttext: __(\"Dismiss\"),\n\t\t\trole: \"cancel\",\n\t\t})\n\t}\n\n\tshowActionSheet.value = true\n}\n\nconst applyWorkflow = async ({ event = \"\", workflowAction = \"\" }) => {\n\tconst action = workflowAction || event.detail.data?.action\n\tif (action) {\n\t\tawait props.workflow.applyWorkflow(props.doc, action)\n\t\tmodalController.dismiss()\n\t\temit(\"workflow-applied\")\n\t}\n\n\tshowActionSheet.value = false\n}\n\nonMounted(() => getTransitions())\n</script>\n\n<style scoped>\nion-action-sheet {\n\t--button-color: var(--text-gray-500);\n}\n</style>\n","import { createResource, toast } from \"frappe-ui\"\nimport { computed } from \"vue\"\nimport { userResource } from \"@/data/user\"\n\nexport default function useWorkflow(doctype) {\n\tconst workflowDoc = createResource({\n\t\turl: \"hrms.api.get_workflow\",\n\t\tparams: { doctype: doctype },\n\t\tcache: [\"hrms:workflow\", doctype],\n\t})\n\tworkflowDoc.reload()\n\n\tconst hasWorkflow = computed(() => {\n\t\tconst workflowData = workflowDoc?.data\n\t\treturn Boolean(Object.keys(workflowData || {}).length > 0)\n\t})\n\n\tconst getWorkflowStateField = () => {\n\t\t// NOTE: checkbox labelled 'Don't Override Status' is named override_status hence the inverted logic\n\t\treturn !workflowDoc.data?.override_status\n\t\t\t? workflowDoc.data?.workflow_state_field\n\t\t\t: \"\"\n\t}\n\n\tconst getDefaultState = (docstatus) => {\n\t\treturn workflowDoc.data?.states.find(\n\t\t\t(state) => state.doc_status == docstatus\n\t\t)\n\t}\n\n\tconst getTransitions = async (doc) => {\n\t\tconst transitions = createResource({\n\t\t\turl: \"frappe.model.workflow.get_transitions\",\n\t\t\tparams: { doc: doc },\n\t\t\ttransform: (data) => {\n\t\t\t\tconst isSelfApproval = userResource?.data?.name == doc.owner\n\n\t\t\t\treturn data\n\t\t\t\t\t.filter(\n\t\t\t\t\t\t(transition) => transition.allow_self_approval || !isSelfApproval\n\t\t\t\t\t)\n\t\t\t\t\t.map((transition) => transition.action)\n\t\t\t},\n\t\t})\n\n\t\treturn await transitions.reload()\n\t}\n\n\tconst getDocumentStateRoles = (state) => {\n\t\treturn workflowDoc.data?.states\n\t\t\t.filter((s) => s.state == state)\n\t\t\t.map((s) => s.allow_edit)\n\t}\n\n\tconst isReadOnly = (doc) => {\n\t\tconst state_fieldname = workflowDoc.data?.workflow_state_field\n\t\tif (!state_fieldname) return false\n\n\t\tconst state = doc[state_fieldname] || getDefaultState(doc.docstatus)\n\n\t\tconst roles = getDocumentStateRoles(state)\n\t\treturn !roles.some((role) => userResource.data.roles.includes(role))\n\t}\n\n\tconst applyWorkflow = async (doc, action) => {\n\t\tconst applyWorkflow = createResource({\n\t\t\turl: \"frappe.model.workflow.apply_workflow\",\n\t\t\tparams: { doc: doc, action: action },\n\t\t\tonSuccess() {\n\t\t\t\ttoast({\n\t\t\t\t\ttitle: \"Success\",\n\t\t\t\t\ttext: `Workflow action '${action}' applied successfully`,\n\t\t\t\t\ticon: \"check-circle\",\n\t\t\t\t\tposition: \"bottom-center\",\n\t\t\t\t\ticonClasses: \"text-green-500\",\n\t\t\t\t})\n\t\t\t},\n\t\t\tonError() {\n\t\t\t\ttoast({\n\t\t\t\t\ttitle: \"Error\",\n\t\t\t\t\ttext: `Error applying workflow action: ${action}`,\n\t\t\t\t\ticon: \"alert-circle\",\n\t\t\t\t\tposition: \"bottom-center\",\n\t\t\t\t\ticonClasses: \"text-red-500\",\n\t\t\t\t})\n\t\t\t\tconsole.log(`Error applying workflow action: ${action}`)\n\t\t\t},\n\t\t})\n\t\tawait applyWorkflow.reload()\n\t}\n\n\treturn {\n\t\thasWorkflow,\n\t\tworkflowDoc,\n\t\tgetWorkflowStateField,\n\t\tgetTransitions,\n\t\tgetDocumentStateRoles,\n\t\tisReadOnly,\n\t\tapplyWorkflow,\n\t}\n}\n"],"names":["companyCurrency","createResource","currencySymbols","getCompanyCurrency","company","_b","_a","getCurrencySymbol","currency","props","__props","filename","computed","src","isImageFile","onBeforeUnmount","emit","__emit","showActionSheet","ref","actions","__","inject","getTransitions","__async","transitions","transition","role","theme","variant","icon","actionLabel","showTransitions","applyWorkflow","_0","event","workflowAction","action","modalController","onMounted","useWorkflow","doctype","workflowDoc","hasWorkflow","workflowData","getWorkflowStateField","getDefaultState","docstatus","state","doc","data","isSelfApproval","userResource","getDocumentStateRoles","s","state_fieldname","toast"],"mappings":"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"}