<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graphique d'√âvolution des Salaires - Dynamic</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .year-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .year-selector label {
            font-weight: bold;
            color: #333;
        }
        
        .year-selector select {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        
        .year-selector select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            background: #fee;
            color: #c33;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .chart-container {
            position: relative;
            height: 500px;
            margin: 20px 0;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .legend-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .legend-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid;
        }
        
        .legend-section.net {
            border-left-color: #3b82f6;
        }
        
        .legend-section.earnings {
            border-left-color: #10b981;
        }
        
        .legend-section.deductions {
            border-left-color: #ef4444;
        }
        
        .legend-title {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #333;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .legend-color {
            width: 20px;
            height: 3px;
            margin-right: 10px;
            border-radius: 2px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transform: translateY(0);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.3);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .hidden {
            display: none;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .container > * {
            animation: fadeInUp 0.6s ease forwards;
        }
        
        .chart-container {
            animation-delay: 0.2s;
        }
        
        .legend-container {
            animation-delay: 0.4s;
        }
        
        .stats {
            animation-delay: 0.6s;
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/side-bar}"></div>
    <div class="container">
        <h1>üìà Graphique d'√âvolution des Salaires</h1>
        
        <div class="controls">
            <div class="year-selector">
                <label for="yearSelect">Ann√©e :</label>
                <select id="yearSelect">
                    <option th:each="y : ${#numbers.sequence(2019, 2030)}" th:value="${y}" th:text="${y}"></option>
                </select>
            </div>
        </div>
        
        <div id="loadingMessage" class="loading hidden">
            Chargement des donn√©es...
        </div>
        
        <div id="errorMessage" class="error hidden"></div>
        
        <div id="chartSection" class="hidden">
            <div class="chart-container">
                <canvas id="salaryChart"></canvas>
            </div>
            
            <div class="legend-container">
                <div class="legend-section net">
                    <div class="legend-title">üí∞ Salaire Net Total</div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3b82f6;"></div>
                        <span>√âvolution du salaire net mensuel</span>
                    </div>
                </div>
                
                <div class="legend-section earnings">
                    <div class="legend-title">üìà Gains et Primes</div>
                    <div id="earningsLegend"></div>
                </div>
                
                <div class="legend-section deductions">
                    <div class="legend-title">üìâ D√©ductions</div>
                    <div id="deductionsLegend"></div>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalNetValue">0 ‚Ç¨</div>
                    <div class="stat-label">Total Net Cumul√©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="averageNetValue">0 ‚Ç¨</div>
                    <div class="stat-label">Moyenne Mensuelle</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="monthsWithData">0</div>
                    <div class="stat-label">Mois avec Donn√©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="evolutionPercent">0%</div>
                    <div class="stat-label">√âvolution</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let salaryChart = null;
        
        // Fonction pour formater les nombres
        function formatCurrency(value) {
            return value.toLocaleString('fr-FR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' ‚Ç¨';
        }
        
        // Fonction pour charger les donn√©es depuis l'API ERPNext via le service Spring
        async function loadSalaryData(year) {
            try {
                showLoading(true);
                hideError();
                
                // Appel via le service Spring Boot au lieu d'appeler directement ERPNext
                const response = await fetch(`/api/hrms/salary-evolution-data?year=${year}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.message) {
                    return data;
                } else {
                    throw new Error('Format de donn√©es invalide');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es:', error);
                showError(`Erreur lors du chargement des donn√©es: ${error.message}`);
                return null;
            } finally {
                showLoading(false);
            }
        }
        
        // Fonctions d'affichage des √©tats
        function showLoading(show) {
            document.getElementById('loadingMessage').classList.toggle('hidden', !show);
            document.getElementById('chartSection').classList.toggle('hidden', show);
        }
        
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            document.getElementById('chartSection').classList.add('hidden');
        }
        
        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }
        
        // Traitement des donn√©es
        function processData(data) {
            const monthlyData = data.message.monthly_data;
            const labels = monthlyData.map(item => item.month_short);
            const totalNetData = monthlyData.map(item => item.total_net);
            
            // Collecter tous les composants uniques (seulement pour les mois avec des donn√©es)
            const allEarnings = new Set();
            const allDeductions = new Set();
            
            monthlyData.forEach(item => {
                if (item.total_net > 0) { // Seulement si il y a des donn√©es
                    if (item.earnings) {
                        Object.keys(item.earnings).forEach(key => {
                            if (item.earnings[key] > 0) { // Seulement si la valeur est positive
                                allEarnings.add(key);
                            }
                        });
                    }
                    if (item.deductions) {
                        Object.keys(item.deductions).forEach(key => {
                            if (item.deductions[key] > 0) { // Seulement si la valeur est positive
                                allDeductions.add(key);
                            }
                        });
                    }
                }
            });
            
            // Couleurs pour les gains (verts)
            const earningsColors = [
                '#10b981', '#059669', '#047857', '#065f46', '#064e3b',
                '#16a34a', '#15803d', '#166534', '#14532d', '#052e16'
            ];
            
            // Couleurs pour les d√©ductions (rouges)
            const deductionsColors = [
                '#ef4444', '#dc2626', '#b91c1c', '#991b1b', '#7f1d1d',
                '#f87171', '#fca5a5', '#fecaca', '#fee2e2', '#fef2f2'
            ];
            
            const datasets = [
                // Ligne principale - Salaire Net Total (Bleu)
                {
                    label: 'Salaire Net Total',
                    data: totalNetData,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 4,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 3,
                    pointRadius: 8,
                    pointHoverRadius: 10,
                    order: 1
                }
            ];
            
            // Ajouter les lignes de gains (Vert)
            let earningsIndex = 0;
            allEarnings.forEach(earning => {
                const earningData = monthlyData.map(item => 
                    item.earnings && item.earnings[earning] ? item.earnings[earning] : 0
                );
                
                datasets.push({
                    label: earning,
                    data: earningData,
                    borderColor: earningsColors[earningsIndex % earningsColors.length],
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    borderDash: [5, 5],
                    order: 2
                });
                earningsIndex++;
            });
            
            // Ajouter les lignes de d√©ductions (Rouge)
            let deductionsIndex = 0;
            allDeductions.forEach(deduction => {
                const deductionData = monthlyData.map(item => 
                    item.deductions && item.deductions[deduction] ? item.deductions[deduction] : 0
                );
                
                datasets.push({
                    label: deduction,
                    data: deductionData,
                    borderColor: deductionsColors[deductionsIndex % deductionsColors.length],
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    borderDash: [2, 2],
                    order: 3
                });
                deductionsIndex++;
            });
            
            return { labels, datasets, allEarnings, allDeductions };
        }
        
        // Cr√©ation des l√©gendes personnalis√©es
        function createLegends(allEarnings, allDeductions) {
            const earningsLegend = document.getElementById('earningsLegend');
            const deductionsLegend = document.getElementById('deductionsLegend');
            
            const earningsColors = ['#10b981', '#059669', '#047857', '#065f46', '#064e3b'];
            const deductionsColors = ['#ef4444', '#dc2626', '#b91c1c', '#991b1b', '#7f1d1d'];
            
            let earningsHTML = '';
            if (allEarnings.size === 0) {
                earningsHTML = '<div class="legend-item"><span>Aucun gain trouv√©</span></div>';
            } else {
                let earningsIndex = 0;
                allEarnings.forEach(earning => {
                    earningsHTML += `
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: ${earningsColors[earningsIndex % earningsColors.length]}; border-style: dashed;"></div>
                            <span>${earning}</span>
                        </div>
                    `;
                    earningsIndex++;
                });
            }
            earningsLegend.innerHTML = earningsHTML;
            
            let deductionsHTML = '';
            if (allDeductions.size === 0) {
                deductionsHTML = '<div class="legend-item"><span>Aucune d√©duction trouv√©e</span></div>';
            } else {
                let deductionsIndex = 0;
                allDeductions.forEach(deduction => {
                    deductionsHTML += `
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: ${deductionsColors[deductionsIndex % deductionsColors.length]}; border-style: dotted;"></div>
                            <span>${deduction}</span>
                        </div>
                    `;
                    deductionsIndex++;
                });
            }
            deductionsLegend.innerHTML = deductionsHTML;
        }
        
        // Mise √† jour des statistiques
        function updateStats(data) {
            const monthlyData = data.message.monthly_data;
            const validData = monthlyData.filter(item => item.total_net > 0);
            
            const totalNet = validData.reduce((sum, item) => sum + item.total_net, 0);
            const averageNet = validData.length > 0 ? totalNet / validData.length : 0;
            const monthsCount = validData.length;
            
            let evolutionPercent = 0;
            if (validData.length >= 2) {
                const firstValue = validData[0].total_net;
                const lastValue = validData[validData.length - 1].total_net;
                if (firstValue > 0) {
                    evolutionPercent = ((lastValue - firstValue) / firstValue) * 100;
                }
            }
            
            document.getElementById('totalNetValue').textContent = formatCurrency(totalNet);
            document.getElementById('averageNetValue').textContent = formatCurrency(averageNet);
            document.getElementById('monthsWithData').textContent = monthsCount;
            document.getElementById('evolutionPercent').textContent = `${evolutionPercent.toFixed(1)}%`;
        }
        
        // Cr√©ation/Mise √† jour du graphique
        async function updateChart(year) {
            const data = await loadSalaryData(year);
            if (!data) return;
            
            const processedData = processData(data);
            createLegends(processedData.allEarnings, processedData.allDeductions);
            updateStats(data);
            
            // D√©truire le graphique existant
            if (salaryChart) {
                salaryChart.destroy();
            }
            
            // Configuration du graphique
            const config = {
                type: 'line',
                data: {
                    labels: processedData.labels,
                    datasets: processedData.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `√âvolution Mensuelle des Salaires - ${year}`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#333',
                            padding: 20
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(59, 130, 246, 0.5)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return context.dataset.label + ': ' + formatCurrency(value);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Mois',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#666'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: '#666'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Montant',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#666'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: '#666',
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    hover: {
                        intersect: false
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }
            };

            // Cr√©ation du graphique
            const ctx = document.getElementById('salaryChart').getContext('2d');
            salaryChart = new Chart(ctx, config);
            
            // Afficher la section du graphique
            document.getElementById('chartSection').classList.remove('hidden');
        }
        
        // Gestionnaire d'√©v√©nements pour le s√©lecteur d'ann√©e
        document.getElementById('yearSelect').addEventListener('change', function() {
            const selectedYear = this.value;
            updateChart(selectedYear);
        });
        
        // Chargement initial
        document.addEventListener('DOMContentLoaded', function() {
            const currentYear = new Date().getFullYear();
            document.getElementById('yearSelect').value = currentYear;
            updateChart(currentYear);
        });
    </script>
    <div th:replace="~{fragments/footer}"></div>    
</body>
</html>